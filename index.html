<!DOCTYPE html>
<html lang="ja" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portfolio | Creative Engineer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Three.js & OrbitControls & GLTFLoader CDN -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.154.0/examples/jsm/"
        }
      }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #0f172a; /* slate-900 */
            color: #f8fafc; /* slate-50 */
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* カスタムスクロールバー */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* アニメーション */
        .reveal {
            opacity: 0; transform: translateY(20px);
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .reveal.active { opacity: 1; transform: translateY(0); }

        /* 背景装飾 */
        .blob {
            position: absolute; filter: blur(80px); z-index: -1; opacity: 0.4;
            animation: float 20s infinite alternate;
        }
        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, -30px) scale(1.1); }
        }

        /* モーダル */
        #modal-overlay { transition: opacity 0.3s ease; }
        .modal-open { opacity: 1; pointer-events: auto; }
        .modal-closed { opacity: 0; pointer-events: none; }

        /* レイアウト定義 */
        @media (min-width: 768px) {
            .sidebar {
                width: 280px; height: 100vh; position: fixed; left: 0; top: 0; overflow-y: auto;
            }
            .main-content {
                margin-left: 280px; width: calc(100% - 280px);
            }
        }
        @media (max-width: 767px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; width: 100%; padding-bottom: 80px; }
            .mobile-nav {
                position: fixed; bottom: 0; left: 0; width: 100%;
                background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px);
                border-top: 1px solid rgba(255,255,255,0.1); z-index: 50;
                display: flex; justify-content: space-around; padding: 10px 0;
            }
            /* スマホでのモーダル調整 */
            #modal-content {
                height: 85vh;
                max-height: 85vh;
                display: flex;
                flex-direction: column;
            }
        }

        .view-section { transition: opacity 0.3s ease; }
        .hidden-view { display: none; opacity: 0; }
        
        .cursor-glow {
            width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(56, 189, 248, 0.15), transparent 70%);
            position: fixed; top: 0; left: 0; transform: translate(-50%, -50%);
            pointer-events: none; z-index: 9999; transition: opacity 0.3s;
        }
        /* スマホではカーソルエフェクトを消す */
        @media (hover: none) {
            .cursor-glow { display: none; }
        }

        /* Three.js Canvas Container */
        #tech-cloud-container {
            width: 100%; height: 100%; min-height: 300px;
            position: relative;
        }
        #model-viewer-canvas {
            width: 100%; height: 100%;
            outline: none;
        }

        /* 3D View Switcher Style */
        .view-switcher {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            padding: 4px;
            display: flex;
            gap: 4px;
        }
        .view-btn {
            padding: 6px 12px;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s ease;
            color: #94a3b8;
        }
        .view-btn.active {
            background: #38bdf8;
            color: #0f172a;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.4);
        }

        /* Model Selector (in 3D view) */
        .model-selector {
            display: flex;
            gap: 8px;
            padding: 8px;
            background: rgba(0,0,0,0.5);
            border-radius: 12px;
            backdrop-filter: blur(4px);
            overflow-x: auto;
            max-width: 90%;
            white-space: nowrap;
        }
        .model-btn {
            padding: 4px 10px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: #ccc;
            font-size: 0.65rem;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .model-btn.active { background: #a855f7; color: white; border-color: #a855f7; }
        
        /* Loading Text */
        #loading-indicator {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-family: monospace; color: #38bdf8; background: rgba(0,0,0,0.7);
            padding: 10px 20px; border-radius: 8px; pointer-events: none; display: none;
        }

        /* 3D Tilt Card */
        .tilt-card {
            transform-style: preserve-3d;
            transform: perspective(1000px);
            transition: transform 0.1s ease-out;
        }
        .tilt-content { transform: translateZ(20px); }
        
        /* Gallery Active State */
        .gallery-item.active {
            border-color: #38bdf8;
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.3);
        }
        
        /* Play Icon Overlay */
        .play-icon-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 32px; height: 32px; background: rgba(0,0,0,0.6); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: white; pointer-events: none;
        }
    </style>
</head>
<body class="antialiased">

    <div class="cursor-glow" id="cursor-glow"></div>

    <!-- サイドバー (PC) -->
    <aside class="sidebar bg-slate-900 border-r border-white/5 flex flex-col p-8 z-40">
        <div class="mb-10">
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-cyan-400 to-blue-600 mb-4 p-1">
                <div class="w-full h-full rounded-full bg-slate-800 flex items-center justify-center overflow-hidden">
                    <i class="ph-fill ph-user text-3xl text-slate-400"></i>
                </div>
            </div>
            <h1 class="text-xl font-bold text-white tracking-tight">Portfolio</h1>
            <p class="text-xs text-slate-400 mt-1">Engineer / Matsuda Lab</p>
        </div>

        <nav class="flex-1 space-y-2">
            <a href="#" onclick="switchView('creative'); return false;" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl bg-slate-800 text-cyan-400 font-bold transition-all hover:bg-slate-800">
                <i class="ph-bold ph-squares-four"></i> Creative
            </a>
            <a href="#" onclick="switchView('resume'); return false;" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all">
                <i class="ph-bold ph-read-cv-logo"></i> Resume
            </a>
            <div class="pt-6 mt-6 border-t border-white/5">
                <p class="text-xs text-slate-500 uppercase tracking-wider mb-3">Links</p>
                <a href="#works" class="block px-4 py-2 text-sm text-slate-400 hover:text-white transition-colors">Works</a>
                <a href="#contact" class="block px-4 py-2 text-sm text-slate-400 hover:text-white transition-colors">Contact</a>
            </div>
        </nav>
        <div class="text-xs text-slate-600 mt-auto">&copy; 2024 Portfolio.</div>
    </aside>

    <!-- モバイルナビ -->
    <nav class="mobile-nav md:hidden">
        <button onclick="switchView('creative')" class="flex flex-col items-center text-cyan-400 w-1/3">
            <i class="ph-bold ph-squares-four text-xl"></i><span class="text-[10px] mt-1">Creative</span>
        </button>
        <button onclick="switchView('resume')" class="flex flex-col items-center text-slate-400 w-1/3">
            <i class="ph-bold ph-read-cv-logo text-xl"></i><span class="text-[10px] mt-1">Resume</span>
        </button>
        <button onclick="document.getElementById('contact').scrollIntoView()" class="flex flex-col items-center text-slate-400 w-1/3">
            <i class="ph-bold ph-envelope text-xl"></i><span class="text-[10px] mt-1">Contact</span>
        </button>
    </nav>

    <!-- メインエリア -->
    <main class="main-content relative min-h-screen">
        <div class="blob w-96 h-96 bg-blue-600 rounded-full top-20 right-20 opacity-20"></div>
        <div class="blob w-64 h-64 bg-purple-600 rounded-full bottom-40 left-20 opacity-20" style="animation-delay: -5s;"></div>

        <!-- ============ CREATIVE VIEW ============ -->
        <div id="creative-view" class="view-section p-6 md:p-12 lg:p-16">
            
            <!-- Hero -->
            <header class="flex flex-col lg:flex-row items-center gap-12 mb-32 min-h-[50vh] lg:min-h-screen">
                <div class="lg:w-1/2 reveal order-2 lg:order-1">
                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-cyan-500/10 border border-cyan-500/20 text-cyan-400 text-xs font-bold mb-6">
                        <span class="w-2 h-2 rounded-full bg-cyan-400 animate-pulse"></span>
                        Available for New Projects
                    </div>
                    <h1 class="text-5xl md:text-7xl font-black leading-tight mb-6">
                        Expand<br><span class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500">Experience.</span>
                    </h1>
                    <p class="text-slate-400 text-lg leading-relaxed max-w-xl mb-8">
                        情報系学部3年 / 松田研究室。<br>
                        Unity, Python, Flutter を駆使し、ハードウェアからソフトウェアまで「体験」を作り出すエンジニア。
                    </p>
                    <div class="flex gap-4">
                        <button onclick="document.getElementById('works').scrollIntoView()" class="px-8 py-3 bg-white text-slate-900 font-bold rounded-full hover:bg-cyan-400 transition-colors">View Works</button>
                        <button onclick="switchView('resume')" class="px-8 py-3 border border-slate-700 text-white font-bold rounded-full hover:border-white transition-colors">Resume</button>
                    </div>
                </div>
                
                <!-- Right Column: Interactive Tech Cloud (Three.js) -->
                <div class="lg:w-1/2 w-full h-[300px] md:h-[400px] lg:h-[500px] reveal order-1 lg:order-2" style="transition-delay: 0.1s;">
                    <div class="w-full h-full relative rounded-3xl bg-slate-900/50 border border-white/5 overflow-hidden flex items-center justify-center">
                        <!-- Three.js Container -->
                        <div id="tech-cloud-container"></div>
                    </div>
                </div>
            </header>

            <!-- Stats -->
            <section id="about" class="grid grid-cols-2 gap-4 md:gap-6 mb-32 reveal max-w-2xl">
                <div class="p-6 bg-slate-800/50 rounded-2xl border border-white/5">
                    <div class="text-3xl font-bold text-white mb-1">9+</div>
                    <div class="text-xs text-slate-400 uppercase tracking-wider">Projects</div>
                </div>
                <div class="p-6 bg-slate-800/50 rounded-2xl border border-white/5">
                    <div class="text-3xl font-bold text-white mb-1">3<span class="text-sm">Years</span></div>
                    <div class="text-xs text-slate-400 uppercase tracking-wider">Unity / C#</div>
                </div>
            </section>

            <!-- Works -->
            <section id="works" class="mb-20">
                <div class="flex flex-col md:flex-row md:items-end justify-between mb-10 reveal gap-4">
                    <div>
                        <h2 class="text-3xl font-bold">Featured Works</h2>
                        <p class="text-slate-400 text-sm mt-2">制作実績</p>
                    </div>
                    <div class="flex gap-2 text-sm overflow-x-auto pb-2 md:pb-0">
                        <button class="tab-btn active px-4 py-1.5 rounded-full bg-white/10 text-white hover:bg-white/20 transition-all flex-shrink-0" data-filter="all">All</button>
                        <button class="tab-btn px-4 py-1.5 rounded-full text-slate-400 hover:text-white hover:bg-white/5 transition-all flex-shrink-0" data-filter="vr">VR/Game</button>
                        <button class="tab-btn px-4 py-1.5 rounded-full text-slate-400 hover:text-white hover:bg-white/5 transition-all flex-shrink-0" data-filter="app">App</button>
                    </div>
                </div>
                <div id="works-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 reveal"></div>
            </section>

            <!-- Contact -->
            <section id="contact" class="bg-gradient-to-r from-blue-900/40 to-purple-900/40 rounded-3xl p-8 md:p-16 text-center border border-white/5 reveal mb-10">
                <h2 class="text-3xl font-bold mb-4">Let's work together.</h2>
                <p class="text-slate-300 mb-8 max-w-lg mx-auto">プロジェクトの詳細やインターンシップについて、お気軽にご連絡ください。</p>
                <a href="mailto:email@example.com" class="inline-flex items-center gap-2 px-8 py-3 bg-white text-slate-900 font-bold rounded-full hover:bg-cyan-400 transition-colors">
                    <i class="ph-bold ph-paper-plane-right"></i> Send Message
                </a>
            </section>
        </div>

        <!-- ============ RESUME VIEW ============ -->
        <div id="resume-view" class="view-section hidden-view p-6 md:p-12 lg:p-16 max-w-4xl">
            <div class="border-b border-white/10 pb-8 mb-12">
                <h2 class="text-3xl font-bold mb-2">Resume</h2>
                <div class="flex flex-wrap gap-4 text-sm text-slate-400">
                    <span class="flex items-center gap-1"><i class="ph-bold ph-student"></i> 松田研究室 (情報の可視化)</span>
                    <span class="flex items-center gap-1"><i class="ph-bold ph-map-pin"></i> Japan</span>
                </div>
            </div>

            <!-- Skills -->
            <div class="mb-16">
                <h3 class="text-lg font-bold text-cyan-400 mb-6 uppercase tracking-wider">Technical Skills</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h4 class="font-bold mb-4 border-l-2 border-slate-700 pl-3">Development</h4>
                        <ul class="space-y-4 text-sm text-slate-300">
                            <li class="flex justify-between"><span>Unity (C#)</span> <span class="text-slate-500">3 Years</span></li>
                            <li class="flex justify-between"><span>HTML/CSS/JS</span> <span class="text-slate-500">2 Years</span></li>
                            <li class="flex justify-between"><span>Flutter (Dart)</span> <span class="text-slate-500">1 Year</span></li>
                            <li class="flex justify-between"><span>Python (ML)</span> <span class="text-slate-500">0.5 Year</span></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold mb-4 border-l-2 border-slate-700 pl-3">Design & Hardware</h4>
                        <ul class="space-y-4 text-sm text-slate-300">
                            <li class="flex justify-between"><span>Maya</span> <span class="text-slate-500">3 Years</span></li>
                            <li class="flex justify-between"><span>Fusion 360</span> <span class="text-slate-500">1 Year</span></li>
                            <li class="flex justify-between"><span>UI/UX Design</span> <span class="text-slate-500">2 Years</span></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- History -->
            <div>
                <h3 class="text-lg font-bold text-cyan-400 mb-6 uppercase tracking-wider">Project History</h3>
                <div class="space-y-4" id="resume-list"></div>
            </div>
        </div>
    </main>

    <!-- 詳細モーダル -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/95 backdrop-blur-md z-[100] modal-closed flex items-center justify-center p-0 md:p-4" onclick="closeModal()">
        <!-- 修正箇所: h-full md:h-[90vh] にしてPCでも画面内に収める。親divにflexを指定してレイアウト崩れを防ぐ -->
        <div id="modal-content" class="bg-slate-800 border-0 md:border border-white/10 rounded-t-2xl md:rounded-2xl w-full max-w-6xl h-full md:h-[90vh] overflow-hidden shadow-2xl relative flex flex-col md:block" onclick="event.stopPropagation()">
            <button onclick="closeModal()" class="fixed top-4 right-4 md:top-6 md:right-6 w-10 h-10 bg-black/60 rounded-full flex items-center justify-center text-white hover:bg-black/80 transition-colors z-50">
                <i class="ph-bold ph-x"></i>
            </button>
            
            <!-- 修正箇所: h-fullで高さを最大化 -->
            <div class="flex flex-col md:flex-row h-full">
                <!-- 左側：ビューワーエリア (Image or 3D or Video) -->
                <!-- 修正箇所: md:h-full でPC時に高さいっぱいに -->
                <div class="w-full md:w-3/5 p-0 flex flex-col bg-black relative flex-shrink-0 h-[300px] md:h-full">
                    
                    <!-- 3D View Switcher (右下配置) -->
                    <div id="view-switcher-container" class="absolute bottom-6 right-6 z-20 view-switcher hidden">
                        <button id="tab-image" onclick="switchModalTab('image')" class="view-btn active">
                            <i class="ph-fill ph-image"></i> Image
                        </button>
                        <button id="tab-3d" onclick="switchModalTab('3d')" class="view-btn">
                            <i class="ph-fill ph-cube"></i> 3D View
                        </button>
                    </div>

                    <!-- Media Container (Image/Video) -->
                    <div id="modal-view-image" class="w-full h-full flex items-center justify-center relative bg-black">
                        <!-- Image Element -->
                        <img id="modal-img" src="" alt="Project" class="max-w-full max-h-full object-contain" onerror="this.style.display='none'; document.getElementById('media-fallback').style.display='flex';">
                        
                        <!-- Video Element -->
                        <!-- 修正: max-h-full で縦長動画も枠内に収める -->
                        <video id="modal-video" class="w-full h-full max-h-full object-contain hidden" loop muted playsinline controls>
                            <source src="" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>

                        <!-- Fallback -->
                        <div id="media-fallback" class="hidden w-full h-full absolute inset-0 flex-col items-center justify-center text-slate-500 text-sm">
                            <i class="ph-duotone ph-image text-3xl mb-2"></i>
                            <span id="fallback-text">No Image/Video</span>
                        </div>
                    </div>

                    <!-- 3D Viewer Container -->
                    <div id="modal-view-3d" class="w-full h-full hidden relative bg-slate-950">
                        <div id="model-viewer-container" class="w-full h-full"></div>
                        <div id="loading-indicator">Loading...</div>
                        
                        <div id="model-selector-container" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 z-20 model-selector hidden">
                            <!-- Buttons injected by JS -->
                        </div>

                        <div class="absolute top-4 left-4 text-[10px] text-slate-500 font-mono pointer-events-none bg-black/50 px-2 py-1 rounded">
                            Mouse: Rotate / Scroll: Zoom / RightClick: Pan
                        </div>
                    </div>
                </div>

                <!-- 右側：情報 & ギャラリー -->
                <div class="w-full md:w-2/5 p-0 flex flex-col border-l border-white/5 bg-slate-900 h-full overflow-y-auto">
                    <div class="p-8 border-b border-white/5 flex-shrink-0">
                         <div id="modal-tags" class="flex gap-2 mb-4"></div>
                        <h3 id="modal-title" class="text-2xl font-bold mb-1 text-white">Title</h3>
                        <p id="modal-sub" class="text-cyan-400 text-sm font-bold mb-6">Subtitle</p>
                        <div class="space-y-6 text-slate-300 text-sm leading-relaxed">
                            <div><h4 class="text-white font-bold mb-1">概要</h4><p id="modal-desc">...</p></div>
                            <div><h4 class="text-white font-bold mb-1">技術的アプローチ</h4><p id="modal-tech">...</p></div>
                            <div class="pt-4 border-t border-white/10">
                                <h4 class="text-slate-500 text-xs uppercase mb-2">Tech Stack</h4>
                                <div id="modal-stack" class="flex flex-wrap gap-2"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ギャラリー -->
                    <div class="p-8 bg-slate-900/50 flex-shrink-0">
                        <h4 class="text-white font-bold mb-4 flex items-center gap-2 text-sm">
                            <i class="ph-fill ph-images-square text-cyan-400"></i>
                            Gallery
                        </h4>
                        <div id="modal-gallery" class="grid grid-cols-2 gap-4">
                            <!-- JSで画像リストを生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Logic Script -->
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- データ定義 ---
        const projects = [
            {
                id: 1, title: "VR対応型 FPSゲーム", category: "vr", subtitle: "県プロコン「優良賞」受賞 / 代表作",
                image: "./images/vr_fps.png",
                desc: "Meta Quest 2を使用した、最大6人対戦可能なVRシューティング。ネットワーク対戦対応。",
                tech: "VR酔い防止のためフレームレート維持を最優先。オブジェクトのローポリ化とカリング処理を独自調整。",
                stack: ["Unity", "C#", "Photon", "Maya"],
                gallery: [
                    { src: "./images/vr_fps/vr_fps.png", caption: "Gameplay" },
                    { src: "./images/vr_fps/vr_fps_weapon.png", caption: "Weapon Model" },
                    { src: "./images/vr_fps/vr_fps_ui.png", caption: "Ui design" }
                ],
                has3D: true,
                models: [
                    { id: 'hk45', name: 'HK45' },
                    { id: 'spas12', name: 'SPAS-12' },
                    { id: 'mp5', name: 'MP5' },
                    { id: 'l96a1', name: 'L96A1' }
                ]
            },
            {
                id: 2,
                title: "駅〜大学間バス時刻表",
                category: "app",
                subtitle: "Unity WebGL / 便利ツール",
                image: "./images/bus_schedule_icon.png", 
                desc: "大学の送迎バスの発車時刻をカウントダウン表示するツール。Unity WebGLでビルドし、ブラウザ上で手軽に確認できるようにしました。",
                tech: "Unity (WebGL), C#, uGUI, CSV Parser",
                stack: ["Unity", "C#", "WebGL"],
                gallery: [
                    { src: "./images/bus_schedule_icon.png", caption: "Main View" },
                    { src: "./images/bus_schedule/bus_schedule.png", caption: "Mobile View" },
                    { src: "./images/bus_schedule/bus_schedule_demo.mp4", caption: "Demo Video" }
                ],
                has3D: false
            },
            {
                id: 3, title: "学内最短経路ナビ", category: "app", subtitle: "Python / 機械学習",
                image: "./images/python_nav.png",
                desc: "キャンパス内の現在地と目的地を入力すると、混雑状況を予測して最短経路を提示。",
                tech: "NetworkXでダイクストラ法を実装。scikit-learnで混雑予測モデルを作成。",
                stack: ["Python", "scikit-learn", "NetworkX"],
                gallery: [
                    { src: "./images/python_nav.png", caption: "Main View" },
                    { src: "./images/python_nav/graph.png", caption: "Graph Data" },
                    { src: "./images/python_nav/demo.png", caption: "Demo" }
                ],
                has3D: false
            },
            {
                id: 4, title: "MailTalk", category: "app", subtitle: "モバイルアプリ / UI UX",
                image: "./images/mailtalk.png",
                desc: "メールをチャット形式で表示・管理できるアプリ。",
                tech: "IMAPプロトコル解析と独自パーサーによりメール本文をチャット風に整形。",
                stack: ["Flutter", "Dart", "IMAP"],
                gallery: [
                    { src: "./images/mailtalk.png", caption: "View" },
                    { src: "./images/mailtalk/chat_list.png", caption: "Chat_list UI" },
                    { src: "./images/mailtalk/chat.png", caption: "Chat UI" }
                ],
                has3D: false
            },
            {
                id: 5, 
                title: "PCペット育成ゲーム", 
                category: "app", 
                subtitle: "架空OS風 育成シミュレーション",
                image: "./images/pc_pet.png",
                desc: "Windowsのデスクトップ画面を模した『架空のOS空間』の中で、不思議な生物を育成するシミュレーションゲーム。",
                tech: "uGUIを駆使してウィンドウやタスクバーの挙動を再現。ショートカットアイコンに見立てたアイテムで餌をあげるなど、OSの操作感とゲームプレイを融合させたDiegetic UI設計。",
                stack: ["Unity", "C#", "uGUI"],
                gallery: [
                    { src: "./images/pc_pet.png", caption: "Desktop View" },
                    { src: "./images/pc_pet/demo.mp4", caption: "View" },
                ],
                has3D: false
            },
            {
                id: 6, title: "Wikipedia Golf", category: "app", subtitle: "Web Game / SPA",
                image: "./images/wiki_golf.png",
                desc: "リンクを辿りゴールを目指すブラウザゲーム。",
                tech: "MediaWiki APIと非同期通信を利用した動的DOM生成。",
                stack: ["JavaScript", "HTML/CSS", "API"],
                gallery: [
                    { src: "./images/wiki_golf/wiki_golf_home.png", caption: "Icon" },
                    { src: "./images/wiki_golf/wiki_golf_gameplay.png", caption: "Gameplay" },
                    { src: "./images/wiki_golf/wiki_golf_result.png", caption: "Result" }
                ],
                has3D: false
            },
            {
                id: 7, title: "NewDealPoker", category: "app", subtitle: "Realtime WebSocket",
                image: "./images/poker_game.png",
                desc: "エクイティ分配導入の新ルールポーカー。",
                tech: "WebSocketでのリアルタイム同期とサーバーサイド役判定。",
                stack: ["Node.js", "WebSocket", "JS"],
                gallery: [
                    { src: "./images/poker_game.png", caption: "Icon" },
                    { src: "./images/poker_game/poker_game_demo.png", caption: "Game Demo" },
                ],
                has3D: false
            },
            {
                id: 8, title: "地域助け合いアプリ", category: "app", subtitle: "Matching App",
                image: "./images/chottohelp.png",
                desc: "「手伝って」をマッチング。高齢者向けデザイン。",
                tech: "Firebase Firestoreバックエンドとアクセシビリティ対応。",
                stack: ["Flutter", "Firebase"],
                gallery: [
                    { src: "./images/chottohelp.png", caption: "Request List" },
                    { src: "./images/chottohelp/chottohelp_list.png", caption: "Request List" },
                    { src: "./images/chottohelp/chottohelp_request.png", caption: "Request Page" }
                ],
                has3D: false
            },
            {
                id: 9, title: "Classroom Twin", category: "model", subtitle: "Digital Twin",
                image: "./images/classroom.png",
                desc: "教室を寸法計測し3DCGで完全再現。",
                tech: "Fusion 360のCADデータとMayaモデリングの統合。",
                stack: ["Maya", "Fusion360"],
                gallery: [
                     { src: "./images/classroom/list.png", caption: "list" },
                     { src: "./images/classroom/chair.png", caption: "chair" },
                     { src: "./images/classroom/locker.png", caption: "locker" }
                ],
                has3D: false
            }
        ];

        // グローバル公開
        window.switchView = switchView;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.switchModalTab = switchModalTab;
        window.changeModel = changeModel;
        window.setMainContent = setMainContent;

        // ==========================================
        // FEATURE 1: Tech Stack 3D Cloud
        // ==========================================
        function initTechCloud() {
            const container = document.getElementById('tech-cloud-container');
            if (!container) return;

            const scene = new THREE.Scene();
            
            const camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 100);
            camera.position.z = 20;

            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);

            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.enableZoom = false;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 2.0;

            const skills = [
                { name: "Unity", color: "#ffffff" }, { name: "C#", color: "#9b4f96" },
                { name: "Python", color: "#3572A5" }, { name: "Maya", color: "#37A5CC" },
                { name: "Flutter", color: "#02569B" }, { name: "Dart", color: "#00B4AB" },
                { name: "Blender", color: "#ea7600" }, { name: "Fusion360", color: "#F05F22" },
                { name: "Git", color: "#F05032" }, { name: "Firebase", color: "#FFCA28" },
                { name: "WebGL", color: "#990000" }
            ];

            const vector = new THREE.Vector3();
            skills.forEach((skill, i) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 256;
                canvas.height = 128;
                
                ctx.fillStyle = "rgba(0,0,0,0)";
                ctx.fillRect(0,0, canvas.width, canvas.height);
                
                ctx.shadowColor = skill.color;
                ctx.shadowBlur = 15;
                
                ctx.font = "bold 40px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillStyle = "white";
                ctx.fillText(skill.name, 128, 64);
                
                ctx.strokeStyle = skill.color;
                ctx.lineWidth = 4;
                ctx.strokeRect(20, 20, 216, 88);

                const texture = new THREE.CanvasTexture(canvas);
                const material = new THREE.SpriteMaterial({ map: texture });
                const sprite = new THREE.Sprite(material);

                const phi = Math.acos(-1 + (2 * i) / skills.length);
                const theta = Math.sqrt(skills.length * Math.PI) * phi;
                
                const r = 8;
                sprite.position.x = r * Math.cos(theta) * Math.sin(phi);
                sprite.position.y = r * Math.sin(theta) * Math.sin(phi);
                sprite.position.z = r * Math.cos(phi);
                
                const scale = 3 + Math.random();
                sprite.scale.set(scale, scale * 0.5, 1);

                scene.add(sprite);
            });

            const particlesGeom = new THREE.BufferGeometry();
            const particlesCount = 200;
            const posArray = new Float32Array(particlesCount * 3);
            for(let i=0; i<particlesCount*3; i++) {
                posArray[i] = (Math.random() - 0.5) * 30;
            }
            particlesGeom.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const particlesMat = new THREE.PointsMaterial({ size: 0.05, color: 0x38bdf8, transparent: true, opacity: 0.5 });
            const particlesMesh = new THREE.Points(particlesGeom, particlesMat);
            scene.add(particlesMesh);

            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();

            window.addEventListener('resize', () => {
                const w = container.clientWidth;
                const h = container.clientHeight;
                renderer.setSize(w, h);
                camera.aspect = w / h;
                camera.updateProjectionMatrix();
            });
        }

        // ==========================================
        // FEATURE 2: 3D Model Viewer (Modal /w GLTFLoader)
        // ==========================================
        let modelViewerRenderer, modelViewerScene, modelViewerCamera, modelViewerControls, modelViewerFrameId;
        let currentModelGroup = null;
        const loader = new GLTFLoader();
        
        function loadModelFile(type) {
            if (!modelViewerScene) return;
            
            const indicator = document.getElementById('loading-indicator');
            if(indicator) {
                indicator.style.display = 'block';
                indicator.innerText = 'Loading...';
                indicator.style.color = '#38bdf8';
            }

            if (currentModelGroup) {
                modelViewerScene.remove(currentModelGroup);
                currentModelGroup = null;
            }

            loader.load(
                `./models/${type}.glb`,
                (gltf) => {
                    currentModelGroup = gltf.scene;
                    
                    const box = new THREE.Box3().setFromObject(currentModelGroup);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());
                    
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const scale = 5 / maxDim; 
                    currentModelGroup.scale.setScalar(scale);
                    
                    currentModelGroup.position.sub(center.multiplyScalar(scale));
                    currentModelGroup.position.y += Math.sin(Date.now() * 0.001) * 0.1; 

                    currentModelGroup.traverse((child) => {
                        if (child.isMesh) {
                            child.material = new THREE.MeshStandardMaterial({
                                color: 0x888888,
                                roughness: 0.6,
                                metalness: 0.4
                            });
                        }
                    });

                    modelViewerScene.add(currentModelGroup);
                    if(indicator) indicator.style.display = 'none';
                },
                undefined,
                (error) => {
                    console.error('An error happened:', error);
                    if(indicator) {
                        indicator.style.color = '#ef4444';
                        indicator.innerText = 'Load Error';
                    }
                }
            );
            
            document.querySelectorAll('.model-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.dataset.model === type) btn.classList.add('active');
            });
        }

        function initModelViewer(containerId, modelType) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = ''; 

            modelViewerScene = new THREE.Scene();
            modelViewerScene.background = new THREE.Color(0x111827);
            
            const gridHelper = new THREE.GridHelper(20, 20, 0x444444, 0x222222);
            modelViewerScene.add(gridHelper);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            modelViewerScene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 1.2);
            dirLight.position.set(5, 10, 7);
            modelViewerScene.add(dirLight);
            const backLight = new THREE.DirectionalLight(0xffffff, 0.5);
            backLight.position.set(-5, 5, -5);
            modelViewerScene.add(backLight);

            const w = container.clientWidth;
            const h = container.clientHeight;

            modelViewerCamera = new THREE.PerspectiveCamera(45, w / h, 0.1, 100);
            modelViewerCamera.position.set(6, 4, 6);
            modelViewerCamera.lookAt(0, 0, 0);

            modelViewerRenderer = new THREE.WebGLRenderer({ antialias: true });
            modelViewerRenderer.setSize(w, h);
            modelViewerRenderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(modelViewerRenderer.domElement);

            modelViewerControls = new OrbitControls(modelViewerCamera, modelViewerRenderer.domElement);
            modelViewerControls.target.set(0, 0, 0);
            modelViewerControls.enableDamping = true;
            modelViewerControls.autoRotate = false;
            modelViewerControls.autoRotateSpeed = 1.0;

            loadModelFile(modelType);

            function animateViewer() {
                modelViewerFrameId = requestAnimationFrame(animateViewer);
                if(currentModelGroup) {
                     currentModelGroup.position.y = Math.sin(Date.now() * 0.001) * 0.2;
                }
                modelViewerControls.update();
                modelViewerRenderer.render(modelViewerScene, modelViewerCamera);
            }
            animateViewer();
        }

        function disposeModelViewer() {
            if (modelViewerFrameId) cancelAnimationFrame(modelViewerFrameId);
            if (modelViewerRenderer) {
                modelViewerRenderer.dispose();
                modelViewerRenderer = null;
            }
        }
        
        function changeModel(type) {
            loadModelFile(type);
        }

        // ==========================================
        // UI Logic
        // ==========================================
        
        function setMainContent(src, element) {
            const mainImg = document.getElementById('modal-img');
            const mainVideo = document.getElementById('modal-video');
            const fallback = document.getElementById('media-fallback');
            
            const isVideo = src.toLowerCase().endsWith('.mp4');

            if (isVideo) {
                mainImg.style.display = 'none';
                mainImg.classList.add('hidden');
                
                mainVideo.src = src;
                mainVideo.classList.remove('hidden');
                mainVideo.style.display = 'block';
                mainVideo.load(); 
                
                const playPromise = mainVideo.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log('Auto-play prevented:', error);
                    });
                }
                
                fallback.style.display = 'none';
            } else {
                mainVideo.pause();
                mainVideo.src = ""; // Unload
                mainVideo.style.display = 'none';
                mainVideo.classList.add('hidden');
                
                mainImg.src = src;
                mainImg.classList.remove('hidden');
                mainImg.style.display = 'block';
                
                fallback.style.display = 'none';
            }
            
            switchModalTab('image');

            if(element) {
                document.querySelectorAll('.gallery-item').forEach(el => el.classList.remove('active'));
                element.classList.add('active');
            }
        }

        function renderCreative(filter = 'all') {
            const grid = document.getElementById('works-grid');
            if(!grid) return;
            grid.innerHTML = '';
            const filtered = filter === 'all' ? projects : projects.filter(p => p.category === filter || (filter==='vr'&&p.category==='model'));

            filtered.forEach((p, index) => {
                const isLarge = index === 0; 
                const colSpan = isLarge ? 'md:col-span-2 xl:col-span-2' : '';
                const height = isLarge ? 'h-80' : 'h-64';

                const card = document.createElement('div');
                card.className = `${colSpan} group relative rounded-2xl overflow-hidden bg-slate-800 border border-white/5 cursor-pointer tilt-card hover:border-cyan-500/30 transition-all`;
                card.style.animation = `fadeIn 0.5s ease forwards ${index * 100}ms`;
                card.onclick = () => openModal(p.id);

                const badge = p.has3D ? `<div class="absolute top-2 right-2 bg-purple-600 text-white text-[10px] font-bold px-2 py-1 rounded z-10 shadow-lg">3D VIEW</div>` : '';

                card.innerHTML = `
                    <div class="${height} w-full relative overflow-hidden bg-black">
                        ${badge}
                        <img src="${p.image}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 group-hover:scale-105 transition-all duration-700"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="hidden w-full h-full absolute inset-0 flex items-center justify-center text-slate-600 bg-slate-900 text-sm">No Image</div>
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent opacity-90"></div>
                        <div class="absolute bottom-0 left-0 p-6 w-full transform translate-y-2 group-hover:translate-y-0 transition-transform duration-300">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-xs font-bold text-cyan-400 uppercase tracking-wider bg-black/50 px-2 py-1 rounded backdrop-blur-sm">${p.stack[0]}</span>
                            </div>
                            <h3 class="text-xl md:text-2xl font-bold text-white mb-1 group-hover:text-cyan-300 transition-colors">${p.title}</h3>
                            <p class="text-sm text-slate-300 line-clamp-1">${p.subtitle}</p>
                        </div>
                    </div>
                `;
                card.addEventListener('mousemove', handleTilt);
                card.addEventListener('mouseleave', resetTilt);
                grid.appendChild(card);
            });
        }

        function renderResume() {
            const list = document.getElementById('resume-list');
            if(!list) return;
            list.innerHTML = projects.map(p => `
                <div class="group flex items-center p-4 rounded-xl bg-slate-800/40 border border-white/5 hover:bg-slate-800 hover:border-cyan-500/30 transition-all cursor-pointer" onclick="openModal(${p.id})">
                    <div class="w-12 h-12 rounded-lg bg-slate-900 flex items-center justify-center mr-4 text-slate-500 group-hover:text-cyan-400 group-hover:bg-cyan-900/20 transition-colors">
                        <i class="ph-fill ph-caret-right text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-white font-bold group-hover:text-cyan-400 transition-colors">${p.title}</h4>
                        <p class="text-xs text-slate-400">${p.subtitle}</p>
                    </div>
                    <div class="text-right hidden sm:block">
                        <span class="text-xs text-slate-500 bg-slate-900 px-2 py-1 rounded border border-slate-700">${p.stack[0]}</span>
                    </div>
                </div>
            `).join('');
        }

        function switchView(mode) {
            const creative = document.getElementById('creative-view');
            const resume = document.getElementById('resume-view');
            const navItems = document.querySelectorAll('.nav-item');

            if (mode === 'creative') {
                creative.classList.remove('hidden-view'); resume.classList.add('hidden-view');
                navItems[0].classList.add('bg-slate-800', 'text-cyan-400'); navItems[0].classList.remove('text-slate-400');
                navItems[1].classList.remove('bg-slate-800', 'text-cyan-400'); navItems[1].classList.add('text-slate-400');
                window.scrollTo(0,0);
                setTimeout(() => window.dispatchEvent(new Event('scroll')), 100);
            } else {
                creative.classList.add('hidden-view'); resume.classList.remove('hidden-view');
                navItems[1].classList.add('bg-slate-800', 'text-cyan-400'); navItems[1].classList.remove('text-slate-400');
                navItems[0].classList.remove('bg-slate-800', 'text-cyan-400'); navItems[0].classList.add('text-slate-400');
                window.scrollTo(0,0);
            }
        }

        // --- Modal Control ---
        const modalOverlay = document.getElementById('modal-overlay');
        let currentProjectId = null;

        function openModal(id) {
            currentProjectId = id;
            const p = projects.find(x => x.id === id);
            if (!p) return;

            const firstMedia = (p.gallery && p.gallery.length > 0) ? p.gallery[0].src : p.image;
            setMainContent(firstMedia, null);

            document.getElementById('modal-title').innerText = p.title;
            document.getElementById('modal-sub').innerText = p.subtitle;
            document.getElementById('modal-desc').innerText = p.desc;
            document.getElementById('modal-tech').innerText = p.tech;

            document.getElementById('modal-stack').innerHTML = p.stack.map(s => 
                `<span class="px-2 py-1 rounded bg-slate-700 text-cyan-300 text-xs border border-slate-600">${s}</span>`
            ).join('');
            
            document.getElementById('modal-tags').innerHTML = 
                `<span class="px-2 py-1 rounded bg-cyan-500/20 text-cyan-400 text-xs font-bold uppercase">${p.category}</span>`;

            const galleryContainer = document.getElementById('modal-gallery');
            galleryContainer.innerHTML = '';
            if (p.gallery && p.gallery.length > 0) {
                p.gallery.forEach((item, index) => {
                    const isVideo = item.src.toLowerCase().endsWith('.mp4');
                    const div = document.createElement('div');
                    div.className = `gallery-item bg-black/50 rounded-lg overflow-hidden border border-white/5 cursor-pointer hover:border-cyan-500 transition-colors ${index===0 ? 'active' : ''}`;
                    div.onclick = function() { setMainContent(item.src, this); };
                    
                    let content = '';
                    if (isVideo) {
                        content = `
                            <div class="h-24 relative flex items-center justify-center bg-black">
                                <video src="${item.src}" class="w-full h-full object-cover opacity-50"></video>
                                <div class="play-icon-overlay"><i class="ph-fill ph-play"></i></div>
                            </div>
                        `;
                    } else {
                        content = `
                            <div class="h-24 relative flex items-center justify-center bg-black">
                                 <img src="${item.src}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                 <div class="hidden w-full h-full absolute inset-0 flex-col items-center justify-center text-slate-600 text-[10px]">
                                    <i class="ph-duotone ph-image text-xl"></i>
                                 </div>
                            </div>
                        `;
                    }
                    div.innerHTML = content;
                    galleryContainer.appendChild(div);
                });
            } else {
                 galleryContainer.innerHTML = `<p class="text-xs text-slate-500 col-span-2 text-center py-4">No gallery images</p>`;
            }

            const viewSwitcher = document.getElementById('view-switcher-container');
            const modelSelector = document.getElementById('model-selector-container');
            
            if (p.has3D) {
                viewSwitcher.style.display = 'flex';
                
                if (p.models && p.models.length > 0) {
                    modelSelector.innerHTML = p.models.map((m, i) => 
                        `<button class="model-btn ${i===0?'active':''}" data-model="${m.id}" onclick="changeModel('${m.id}')">${m.name}</button>`
                    ).join('');
                    modelSelector.classList.remove('hidden');
                } else {
                    modelSelector.classList.add('hidden');
                }
            } else {
                viewSwitcher.style.display = 'none';
                modelSelector.classList.add('hidden');
            }

            modalOverlay.classList.remove('modal-closed');
            modalOverlay.classList.add('modal-open');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            modalOverlay.classList.remove('modal-open');
            modalOverlay.classList.add('modal-closed');
            document.body.style.overflow = '';
            
            const mainVideo = document.getElementById('modal-video');
            mainVideo.pause();
            mainVideo.src = "";
            
            disposeModelViewer();
        }

        function switchModalTab(tab) {
            const btnImage = document.getElementById('tab-image');
            const btn3D = document.getElementById('tab-3d');
            const viewImage = document.getElementById('modal-view-image');
            const view3D = document.getElementById('modal-view-3d');
            const mainVideo = document.getElementById('modal-video');

            if (tab === 'image') {
                btnImage.classList.add('active');
                btn3D.classList.remove('active');
                viewImage.classList.remove('hidden');
                view3D.classList.add('hidden');
                disposeModelViewer();
            } else {
                btn3D.classList.add('active');
                btnImage.classList.remove('active');
                viewImage.classList.add('hidden');
                view3D.classList.remove('hidden');
                mainVideo.pause();
                
                const p = projects.find(x => x.id === currentProjectId);
                const defaultModel = (p && p.models) ? p.models[0].id : 'hk45';
                
                requestAnimationFrame(() => { 
                    initModelViewer('model-viewer-container', defaultModel); 
                });
            }
        }

        // --- Tilt Logic ---
        function handleTilt(e) {
            const rect = this.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            const rotateX = ((y - centerY) / centerY) * -3;
            const rotateY = ((x - centerX) / centerX) * 3;
            this.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.01, 1.01, 1.01)`;
        }
        function resetTilt() {
            this.style.transform = `perspective(1000px) rotateX(0deg) rotateY(0deg) scale3d(1, 1, 1)`;
        }

        // --- Mouse Glow ---
        const glow = document.getElementById('cursor-glow');
        window.addEventListener('mousemove', (e) => {
            glow.style.left = e.clientX + 'px';
            glow.style.top = e.clientY + 'px';
        });

        // --- Filter ---
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('active', 'bg-white/10', 'text-white');
                    b.classList.add('text-slate-400');
                });
                btn.classList.add('active', 'bg-white/10', 'text-white');
                btn.classList.remove('text-slate-400');
                renderCreative(btn.dataset.filter);
            };
        });

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => { if(entry.isIntersecting) entry.target.classList.add('active'); });
        }, { threshold: 0.1 });
        document.querySelectorAll('.reveal').forEach(el => observer.observe(el));

        // INIT
        initTechCloud();
        renderCreative();
        renderResume();

    </script>
</body>
</html>